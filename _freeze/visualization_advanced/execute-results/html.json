{
  "hash": "0b9d238f0e054f3bd1801c60be8e01f5",
  "result": {
    "engine": "knitr",
    "markdown": "# データ可視化応用 - ggplot2発展\n\n前章でggplot2の基本的なグラフ作成を学びました。この章では、より高度なテクニックを使って、プレゼンテーションやレポートで使える洗練されたグラフを作成する方法を学びます。\n\n## 学習内容\n\nこの章を読み終えると、以下ができるようになります。\n\n- ファセット機能で複数のグラフを並べて表示する\n- 色や塗りつぶしでデータをグループ化する\n- 軸のスケールを調整する\n- テーマを細かくカスタマイズする\n- patchworkで異なるグラフを組み合わせる\n- グラフを保存して共有する\n\n## ファセット: 複数グラフの並べて表示\n\nファセット機能を使うと、カテゴリごとにグラフを分割して表示できます。\n\n### facet_wrap()\n\n1つの変数でグラフを分割します。`facet_wrap(~ 変数)`で、指定した変数のカテゴリごとにグラフが作成されます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\ndata(iris)\n\n# 品種ごとにグラフを分割\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +\n  geom_point() +\n  facet_wrap(~ Species) +\n  labs(title = \"品種別のがく片の長さと幅\")\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\n### 分割数の調整\n\n`ncol`引数を使って、列数を指定できます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 列数を指定（2列で表示）\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +\n  geom_point() +\n  facet_wrap(~ Species, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nまた、`nrow`引数を使って行数を指定することもできます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 行数を指定（1行で表示）\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +\n  geom_point() +\n  facet_wrap(~ Species, nrow = 3)\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n### facet_grid()\n\n2つの変数で行と列に分割します。`facet_grid(行の変数 ~ 列の変数)`で、指定した2つの変数の組み合わせごとにグラフが作成されます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# サンプルデータの作成\nsales_data <- data.frame(\n  四半期 = rep(c(\"Q1\", \"Q2\", \"Q3\", \"Q4\"), each = 6),\n  地域 = rep(c(\"東日本\", \"西日本\"), times = 12),\n  商品 = rep(c(\"商品A\", \"商品B\", \"商品C\"), times = 8),\n  売上 = sample(100:500, 24)\n)\n\n# 四半期（行）× 地域（列）でグラフを分割\nggplot(sales_data, aes(x = 商品, y = 売上)) +\n  geom_col() +\n  facet_grid(四半期 ~ 地域)\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n## 色と塗りつぶしの活用\n\n### color vs fill\n\n- `color`: 点や線の色\n- `fill`: 棒や領域の塗りつぶし色\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 棒グラフでfillを使用\niris_summary <- iris |>\n  group_by(Species) |>\n  summarize(平均 = mean(Sepal.Length))\n\nggplot(iris_summary, aes(x = Species, y = 平均, fill = Species)) +\n  geom_col() +\n  labs(title = \"品種別平均がく片長\")\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n### 手動で色を指定\n\n手動で色を指定するには、`scale_color_manual()`や`scale_fill_manual()`を使います。\n\n選び方として、`color`を指定している場合は`scale_color_manual()`、`fill`を指定している場合は`scale_fill_manual()`を使います。\n\n関数内の`values`引数に、カテゴリごとの色を指定します。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 色を手動で指定\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  geom_point(size = 3) +\n  scale_color_manual(\n    values = c(\n      \"setosa\" = \"red\",\n      \"versicolor\" = \"blue\",\n      \"virginica\" = \"green\"\n    )\n  )\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n### カラーパレットの使用\n\n既に用意されているカラーパレットを使うこともできます。`RColorBrewer`パッケージのカラーパレットを利用するには、`scale_color_brewer()`や`scale_fill_brewer()`を使います。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Brewerカラーパレットを使用\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  geom_point(size = 3) +\n  scale_color_brewer(palette = \"Set1\")\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\"Set1\"の他にも、\"Set2\", \"Set3\", \"Pastel1\", \"Dark2\"など、様々なカラーパレットが用意されています。\n\n参考：[R Color Brewer’s palettes](https://r-graph-gallery.com/38-rcolorbrewers-palettes.html)\n\n## 軸のスケール調整\n\n### 軸の範囲を指定\n\n`xlim()`や`ylim()`を使って、軸の表示範囲を指定できます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +\n  geom_point() +\n  xlim(4, 8) +  # x軸の範囲を4〜8に\n  ylim(2, 5)    # y軸の範囲を2〜5に\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n### 軸の目盛りをカスタマイズ\n\n`scale_x_continuous()`や`scale_y_continuous()`を使って、軸の目盛りをカスタマイズできます。`breaks`引数で目盛りの位置を指定します。`by`を使うと、指定した幅で等間隔の目盛りを振ることができます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +\n  geom_point() +\n  scale_x_continuous(breaks = seq(4, 8, by = 0.5)) +\n  scale_y_continuous(breaks = seq(2, 4.5, by = 0.5))\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n## テーマのカスタマイズ\n\n`theme()`関数を使うと、グラフの細部まで調整できます。\n\n### フォントサイズの調整\n\n`theme()`には様々な要素があり、タイトルや軸ラベル、凡例のフォントサイズを調整できます。`axis.*`は軸のテキスト、`legend.*`は凡例のテキストを調整するための要素です。\n\n`element_text()`はテキストのスタイルを指定するための関数で、`face`引数で文字のスタイル（例: \"bold\", \"italic\"）を指定できます。`size`引数でフォントサイズを指定します。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  geom_point() +\n  labs(title = \"がく片の長さと幅\", x = \"長さ (cm)\", y = \"幅 (cm)\") +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 18),\n    axis.title = element_text(size = 14),\n    axis.text = element_text(size = 12),\n    legend.title = element_text(size = 14),\n    legend.text = element_text(size = 12)\n  )\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n### 凡例の位置を変更\n\n`legend.position`で凡例の位置を変更できます。指定できる値は、\"top\", \"bottom\", \"left\", \"right\", \"none\"（凡例を表示しない）などがあります。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  geom_point() +\n  theme_minimal() +\n  theme(\n    legend.position = \"top\"  # \"bottom\", \"left\", \"right\", \"none\"も可\n  )\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n### 背景色の変更\n\nグラフの背景色を変更するには、`panel.background`や`plot.background`を調整します。`panel.background`はグラフの背景、`plot.background`はグラフ全体の背景を指定します。\n\n`element_rect()`は矩形のスタイルを指定するための関数で、`fill`引数で背景色を指定します。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  geom_point() +\n  theme_minimal() +\n  theme(\n    panel.background = element_rect(fill = \"lightgray\"),\n    plot.background = element_rect(fill = \"gray\")\n  )\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n## patchwork: 複数グラフの配置\n\n`patchwork`パッケージを使うと、複数のggplot2グラフを自由にレイアウトして配置できます。ファセット機能では同じデータから自動的に分割しますが、patchworkでは異なるグラフを組み合わせることができます。\n\n### patchworkのインストール\n\n```r\n# パッケージのインストール（初回のみ）\ninstall.packages(\"patchwork\")\n\n# パッケージの読み込み\nlibrary(patchwork)\n```\n\n### 基本的な配置\n\nグラフを変数に保存してから、演算子を使って配置します。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(patchwork)\n\n# 複数のグラフを作成\np1 <- ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +\n  geom_point(color = \"steelblue\") +\n  labs(title = \"がく片\")\n\np2 <- ggplot(iris, aes(x = Petal.Length, y = Petal.Width)) +\n  geom_point(color = \"coral\") +\n  labs(title = \"花弁\")\n\np3 <- ggplot(iris, aes(x = Species, fill = Species)) +\n  geom_bar() +\n  labs(title = \"品種別データ数\") +\n  theme(legend.position = \"none\")\n\np4 <- ggplot(iris, aes(x = Sepal.Length, fill = Species)) +\n  geom_histogram(bins = 15, alpha = 0.7) +\n  labs(title = \"がく片長の分布\")\n```\n:::\n\n\n### 横に並べる（+演算子）\n\n`+`演算子を使うと、グラフを横に並べることができます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 横に並べる\np1 + p2\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n### 縦に並べる（/演算子）\n\n`/`演算子を使うと、グラフを縦に並べることができます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 縦に並べる\np1 / p2\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n### 2行2列に配置\n\n括弧を使って配置を制御できます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 2行2列に配置\n(p1 + p2) / (p3 + p4)\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n### 1つのグラフを大きく配置\n\n`|`演算子を使うと、垂直方向の配置をより細かく制御できます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 左に大きなグラフ、右に2つのグラフを縦に配置\np1 | (p2 / p3)\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n### レイアウトの制御\n\n`plot_layout()`で列数や行数、サイズ比を指定できます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 列数を指定\np1 + p2 + p3 + plot_layout(ncol = 2)\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# サイズ比を指定（左のグラフを2倍の幅に）\np1 + p2 + plot_layout(widths = c(2, 1))\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n### 共通のタイトルと凡例\n\n`plot_annotation()`で全体のタイトルを追加できます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 共通のタイトルを追加\n(p1 + p2) / (p3 + p4) +\n  plot_annotation(\n    title = \"アヤメデータの総合分析\",\n    subtitle = \"4つの観点からの可視化\",\n    caption = \"データ: iris dataset\"\n  )\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\n### 凡例の統一\n\n複数のグラフで共通の凡例を使う場合、`plot_layout(guides = \"collect\")`で凡例をまとめることができます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 品種で色分けしたグラフを作成\np_sepal <- ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  geom_point() +\n  labs(title = \"がく片\")\n\np_petal <- ggplot(iris, aes(x = Petal.Length, y = Petal.Width, color = Species)) +\n  geom_point() +\n  labs(title = \"花弁\")\n\n# 凡例を1つにまとめる\np_sepal + p_petal + plot_layout(guides = \"collect\")\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n## グラフの保存\n\n### 基本的な保存方法\n\n```r\n# 最後に表示したグラフを保存\nggsave(\"outputs/my_plot.png\")\n\n# サイズを指定（インチ単位）\nggsave(\"outputs/my_plot.png\", width = 8, height = 6)\n\n# 解像度を指定（dpi）\nggsave(\"outputs/my_plot.png\", width = 8, height = 6, dpi = 300)\n```\n\n### 複数のファイル形式で保存\n\n```r\n# PNG形式\nggsave(\"outputs/plot.png\", width = 8, height = 6)\n\n# PDF形式（ベクター形式、拡大しても綺麗）\nggsave(\"outputs/plot.pdf\", width = 8, height = 6)\n\n# JPEG形式\nggsave(\"outputs/plot.jpg\", width = 8, height = 6)\n```\n\n### グラフを変数に保存してから保存\n\n```r\n# グラフを変数に保存\nmy_plot <- ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  geom_point() +\n  labs(title = \"がく片の長さと幅\")\n\n# 変数からグラフを保存\nggsave(\"outputs/iris_plot.png\", plot = my_plot, width = 8, height = 6)\n```\n\n## 実践例：完成度の高いグラフ\n\nこれまで学んだテクニックを組み合わせて、レポートやプレゼンで使える完成度の高いグラフを作成してみましょう。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# データの準備\nsales_summary <- data.frame(\n  月 = rep(1:12, times = 3),\n  商品 = rep(c(\"商品A\", \"商品B\", \"商品C\"), each = 12),\n  売上 = c(\n    # 商品A\n    120, 135, 150, 145, 160, 175, 190, 185, 200, 210, 230, 250,\n    # 商品B\n    100, 110, 125, 130, 140, 155, 160, 165, 175, 185, 195, 210,\n    # 商品C\n    80, 90, 95, 100, 110, 120, 125, 130, 140, 150, 160, 175\n  )\n)\n\n# グラフの作成\nfinal_plot <- ggplot(sales_summary, aes(x = 月, y = 売上, color = 商品)) +\n  geom_line(linewidth = 1.2) +\n  geom_point(size = 3) +\n  scale_x_continuous(breaks = 1:12) +\n  scale_color_brewer(palette = \"Set1\") +\n  labs(\n    title = \"2025年 商品別月次売上推移\",\n    subtitle = \"全店舗合計\",\n    x = \"月\",\n    y = \"売上（万円）\",\n    color = \"商品カテゴリ\",\n    caption = \"データ：社内売上システムより\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(size = 18, face = \"bold\"),\n    plot.subtitle = element_text(size = 14, color = \"gray40\"),\n    axis.title = element_text(size = 14),\n    axis.text = element_text(size = 12),\n    legend.position = \"top\",\n    legend.title = element_text(size = 12),\n    legend.text = element_text(size = 11),\n    panel.grid.minor = element_blank(),  # 細かい補助線を削除\n    plot.caption = element_text(size = 10, hjust = 0, color = \"gray50\")\n  )\n\nprint(final_plot)\n```\n\n::: {.cell-output-display}\n![](visualization_advanced_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\n## 練習問題\n\n::: {.callout-tip collapse=\"true\"}\n## 問題1: ファセットグラフの作成\n\n`iris`データで、品種ごとにヒストグラムをファセット表示してください。x軸は`Sepal.Length`です。\n\n**解答例**\n```r\nggplot(iris, aes(x = Sepal.Length)) +\n  geom_histogram(bins = 15, fill = \"steelblue\") +\n  facet_wrap(~ Species) +\n  labs(title = \"品種別がく片長の分布\")\n```\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## 問題2: カスタマイズされた散布図\n\n`iris`データで以下の条件を満たす散布図を作成してください。\n\n- x軸: `Petal.Length`, y軸: `Petal.Width`\n- 品種ごとに色分け\n- タイトル、軸ラベルを日本語で追加\n- テーマを`theme_classic()`に設定\n- 凡例を下に配置\n\n**解答例**\n```r\nggplot(iris, aes(x = Petal.Length, y = Petal.Width, color = Species)) +\n  geom_point(size = 3) +\n  labs(\n    title = \"花弁の長さと幅の関係\",\n    x = \"花弁の長さ (cm)\",\n    y = \"花弁の幅 (cm)\",\n    color = \"品種\"\n  ) +\n  theme_classic() +\n  theme(legend.position = \"bottom\")\n```\n:::\n\n## まとめ\n\nこの章では、ggplot2の発展的なテクニックを学びました。\n\n- ✅ ファセット（`facet_wrap()`, `facet_grid()`）で複数グラフを並べて表示\n- ✅ 色とカラーパレットの活用\n- ✅ 軸のスケール調整\n- ✅ `theme()`による細かいカスタマイズ\n- ✅ `patchwork`で異なるグラフを自由に配置\n- ✅ `ggsave()`によるグラフの保存\n\nこれで、プレゼンテーションやレポートで使える、洗練されたグラフを作成できるようになりました。\n\n::: {.callout-note}\n## データ分析の流れ\n\nここまでで、データ分析の基本的な流れを習得しました。\n\n1. **データの読み込み**（data_io.qmd）\n2. **データの加工**（data_wrangling_basic.qmd, data_wrangling_advanced.qmd）\n3. **データの可視化**（visualization_basic.qmd, visualization_advanced.qmd）\n\n2026年2月現在、作成済みの章はここまでですが、今後内容の拡充を予定しています。特に、データの加工や再現可能な研究の章を充実させていく予定です。\n:::\n",
    "supporting": [
      "visualization_advanced_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}